{% extends 'base.html' %}

{% block title %}Compare DICOM{% endblock %}

{% block extra_css %}
<style>
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #9333ea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .roi-checkbox {
        cursor: pointer;
    }
    
    .roi-checkbox:hover {
        background-color: #f3f4f6;
    }
    
    /* Horizontal slider styling */
    #slice-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: linear-gradient(to right, #9333ea 0%, #9333ea 0%) no-repeat, #e5e7eb;
        background-size: 0% 8px;
        border-radius: 4px;
        outline: none;
        cursor: pointer;
    }
    
    #slice-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #9333ea;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    #slice-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #9333ea;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    #slice-slider::-webkit-slider-runnable-track {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
    }
    
    #slice-slider::-moz-range-track {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Compare DICOM</h1>
                <p class="text-gray-600">View DICOM Images with overlaid RTStructureSet Data.</p>
            </div>
            <a href="{% url 'dicom_handler:view_rt_structure_list' series.series_instance_uid %}" 
               class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                View RT Structure List
            </a>
        </div>
    </div>

    <!-- Patient Information -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <span class="text-gray-500">Patient:</span>
                <span class="text-gray-900 font-medium ml-1">{{ patient_name }} ({{ patient_id }})</span>
            </div>
            <div>
                <span class="text-gray-500">Study Date:</span>
                <span class="text-gray-900 font-medium ml-1">
                    {% if study_date %}{{ study_date|date:"d M Y" }}{% else %}N/A{% endif %}
                </span>
            </div>
            <div>
                <span class="text-gray-500">Series:</span>
                <span class="text-gray-900 font-medium ml-1">{{ series_description|default:"N/A" }}</span>
            </div>
            <div>
                <span class="text-gray-500">Instances:</span>
                <span class="text-gray-900 font-medium ml-1">{{ instance_count }}</span>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="save-message-container" class="mb-6 hidden">
        <div id="save-error-message" class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start">
            <svg class="w-5 h-5 text-red-600 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-red-800 mb-1">Failed to Save Ratings</h3>
                <p id="save-error-text" class="text-sm text-red-700"></p>
            </div>
            <button type="button" onclick="document.getElementById('save-message-container').classList.add('hidden')" class="ml-auto flex-shrink-0 text-red-600 hover:text-red-800">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>

    <!------------------ Overall Structure Set Quality -------------------->
    <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4" id="overall-rating-section">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Overall Structure Set Quality</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="assessor-name" class="block text-sm font-medium text-gray-700 mb-2">
                    Assessor Name <span class="text-red-600">*</span>
                </label>
                <input type="text" id="assessor-name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                       placeholder="Enter your name">
            </div>
            <div>
                <label for="modification-time" class="block text-sm font-medium text-gray-700 mb-2">
                    Time Required (min) <span class="text-red-600">*</span>
                </label>
                <input type="number" id="modification-time" min="0" step="1" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                       placeholder="Minutes">
            </div>
            <div>
                <label for="date-reviewed" class="block text-sm font-medium text-gray-700 mb-2">
                    Date Contour Reviewed <span class="text-red-600">*</span>
                </label>
                <input type="date" id="date-reviewed" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
            </div>
            <div>
                <label for="overall-rating" class="block text-sm font-medium text-gray-700 mb-2">
                    Overall Quality (0-10)
                </label>
                <select id="overall-rating" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    <option value="10">10 - Excellent</option>
                    <option value="9">9</option>
                    <option value="8">8</option>
                    <option value="7">7</option>
                    <option value="6">6</option>
                    <option value="5" selected>5 - Average</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                    <option value="1">1</option>
                    <option value="0">0 - Worst</option>
                </select>
            </div>
        </div>
    </div>

    <div>
        <!------------------------- DICOM Viewer Panel -------------------------->
        <div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <div class="mb-4 bg-gray-100 rounded-lg p-3">
                    <!--------------------- Toolbar ---------------------->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex gap-2">
                            <button id="mode-pan" class="mode-btn px-4 py-2 rounded-md font-medium transition-colors bg-white text-gray-700 hover:bg-gray-200 border border-gray-300">
                                <svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"></path>
                                </svg>
                                Pan
                            </button>
                            <button id="mode-zoom" class="mode-btn px-4 py-2 rounded-md font-medium transition-colors bg-white text-gray-700 hover:bg-gray-200 border border-gray-300">
                                <svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
                                </svg>
                                Zoom
                            </button>
                            <button id="mode-window" class="mode-btn px-4 py-2 rounded-md font-medium transition-colors bg-white text-gray-700 hover:bg-gray-200 border border-gray-300">
                                <svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Window/Level
                            </button>
                            <button id="mode-slice" class="mode-btn px-4 py-2 rounded-md font-medium transition-colors bg-white text-gray-700 hover:bg-gray-200 border border-gray-300">
                                <svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path>
                                </svg>
                                Slice Nav
                            </button>
                        </div>
                        <div class="text-sm font-medium text-gray-600">
                            <span id="current-mode-text">Mode: None</span>
                        </div>
                    </div>

                    <!-- Zoom Controls (shown when zoom mode active) -->
                    <div id="zoom-controls-panel" class="hidden bg-white rounded-lg p-3 border border-gray-300">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-700 whitespace-nowrap">
                                Zoom: <span id="zoom-value" class="font-semibold text-purple-600">100%</span>
                            </label>
                            <input type="range" id="zoom-slider" class="flex-1" min="50" max="400" value="100" step="10">
                            <div class="flex gap-2">
                                <button id="zoom-out-btn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">-</button>
                                <button id="zoom-reset-btn" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">100%</button>
                                <button id="zoom-in-btn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">+</button>
                            </div>
                        </div>
                    </div>

                    <!-- Window/Level Controls (shown when window mode active) -->
                    <div id="window-controls-panel" class="hidden bg-white rounded-lg p-3 border border-gray-300">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Center: <span id="wc-value" class="font-semibold text-purple-600">40</span>
                                </label>
                                <input type="range" id="window-center" class="w-full" min="-1024" max="1024" value="40" step="1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Width: <span id="ww-value" class="font-semibold text-purple-600">400</span>
                                </label>
                                <input type="range" id="window-width" class="w-full" min="1" max="2000" value="400" step="1">
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-5 gap-2">
                            <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="40" data-ww="400">Soft Tissue</button>
                            <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="-600" data-ww="1500">Lung</button>
                            <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="400" data-ww="1800">Bone</button>
                            <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="50" data-ww="350">Brain</button>
                            <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="60" data-ww="360">Liver</button>
                        </div>
                    </div>

                    <!-- Slice Navigation Controls (shown when slice mode active) -->
                    <div id="slice-controls-panel" class="hidden bg-white rounded-lg p-3 border border-gray-300">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-700 whitespace-nowrap">
                                Slice: <span id="current-slice" class="font-semibold text-purple-600">0</span> / <span id="total-slices" class="text-gray-600">0</span>
                            </label>
                            <input type="range" id="slice-slider" min="0" max="0" value="0" disabled class="flex-1">
                            <div class="flex gap-2">
                                <input type="number" id="slice-input" min="1" max="1" value="1" disabled
                                       class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                                <button id="go-to-slice" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:bg-gray-300 text-sm" disabled>Go</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-------------------------- MAIN DICOM VIEW SECTION -------------------------->
                <div class="grid grid-cols-2 gap-4">
                    <div id="viewer-container-left" class="relative flex items-center justify-center"
                        style="min-height: 500px; background: #000; overflow: hidden;">
                        <div class="loading-overlay" id="loading-overlay-left" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                            <div class="text-center text-white"
                                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); min-width: 250px;">
                                <div class="spinner mx-auto mb-3"></div>
                                <p id="loading-text-left" style="white-space: nowrap;">Loading DICOM data...</p>
                            </div>
                        </div>
                        <img id="dicom-image-left" src="" alt="DICOM Image"
                            style="display: none; max-width: 100%; height: auto; transition: transform 0.2s ease;">
                    </div>
                    <div id="viewer-container-right" class="relative flex items-center justify-center"
                        style="min-height: 500px; background: #000; overflow: hidden;">
                        <div class="loading-overlay" id="loading-overlay-right" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                            <div class="text-center text-white"
                                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); min-width: 250px;">
                                <div class="spinner mx-auto mb-3"></div>
                                <p id="loading-text-right" style="white-space: nowrap;">Loading DICOM data...</p>
                            </div>
                        </div>
                        <img id="dicom-image-right" src="" alt="DICOM Image"
                            style="display: none; max-width: 100%; height: auto; transition: transform 0.2s ease;">
                    </div>
                </div>

                <!-- Comparison Rating Section -->
                <div class="mt-6">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200 p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">Which Structure Set is Better?</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                            <!-- Structure Set A -->
                            <div class="text-center">
                                <h4 class="font-medium text-gray-800 mb-3">Structure Set A</h4>
                                <button id="structure-a-btn"
                                    class="w-full px-6 py-3 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 font-medium">
                                    <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Select This
                                </button>
                            </div>
                            <!-- VS indicator -->
                            <div class="text-center">
                                <div class="text-3xl font-bold text-gray-400">VS</div>
                                <div class="text-sm text-gray-500 mt-2">Choose the better option</div>
                            </div>
                            <!-- Structure Set B -->
                            <div class="text-center">
                                <h4 class="font-medium text-gray-800 mb-3">Structure Set B</h4>
                                <button id="structure-b-btn"
                                    class="w-full px-6 py-3 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all duration-200 font-medium">
                                    <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Select This
                                </button>
                            </div>
                        </div>
                        <!-- Selection Result -->
                        <div id="comparison-result" class="mt-6 hidden">
                            <div class="bg-white rounded-lg p-4 border border-green-200">
                                <div class="flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-green-800 font-medium">You selected Structure Set <span
                                            id="selected-structure"></span> as better</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-------------------- RT Structure Selection & Rating ------------------>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sticky top-4 space-y-6 my-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">RT Structures & Quality Rating</h3>
                    <div class="mb-3 grid grid-cols-2 gap-2">
                        <button id="select-all-roi"
                            class="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-xs font-medium transition-colors">
                            Select All
                        </button>
                        <button id="deselect-all-roi"
                            class="px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-xs font-medium transition-colors">
                            Deselect All
                        </button>
                    </div>
                    
                    <button id="apply-overlay"
                        class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors font-medium mb-4">
                        Apply Overlay
                    </button>
            
                    <div id="roi-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- ROI checkboxes with ratings will be populated here -->
                    </div>
                </div>
            </div>
            <!-------------------- RT Structure Selection & Rating ------------>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Viewer State
const viewerState = {
    currentSlice: 0,
    totalSlices: 0,
    windowCenter: 40,
    windowWidth: 400,
    roiNames: [],
    selectedROIs: [],
    isLoading: false,
};

// DOM Elements - Left Viewer
const loadingOverlayLeft = document.getElementById('loading-overlay-left');
const loadingTextLeft = document.getElementById('loading-text-left');
const dicomImageLeft = document.getElementById('dicom-image-left');

// DOM Elements - Right Viewer  
const loadingOverlayRight = document.getElementById('loading-overlay-right');
const loadingTextRight = document.getElementById('loading-text-right');
const dicomImageRight = document.getElementById('dicom-image-right');
const currentSliceSpan = document.getElementById('current-slice');
const totalSlicesSpan = document.getElementById('total-slices');
const sliceSlider = document.getElementById('slice-slider');
const sliceInput = document.getElementById('slice-input');
const goToSliceBtn = document.getElementById('go-to-slice');
const windowCenterInput = document.getElementById('window-center');
const windowWidthInput = document.getElementById('window-width');
const wcValueSpan = document.getElementById('wc-value');
const wwValueSpan = document.getElementById('ww-value');
const roiList = document.getElementById('roi-list');
const selectAllBtn = document.getElementById('select-all-roi');
const deselectAllBtn = document.getElementById('deselect-all-roi');
const applyOverlayBtn = document.getElementById('apply-overlay');
const zoomSlider = document.getElementById('zoom-slider');
const zoomValueSpan = document.getElementById('zoom-value');
const zoomInBtn = document.getElementById('zoom-in-btn');
const zoomOutBtn = document.getElementById('zoom-out-btn');
const zoomResetBtn = document.getElementById('zoom-reset-btn');

// Mode buttons
const modePanBtn = document.getElementById('mode-pan');
const modeZoomBtn = document.getElementById('mode-zoom');
const modeWindowBtn = document.getElementById('mode-window');
const modeSliceBtn = document.getElementById('mode-slice');
const currentModeText = document.getElementById('current-mode-text');

// Cache for pre-rendered slices
const sliceCache = new Map();

// Structure selection
const structureABtn = document.getElementById('structure-a-btn');
const structureBBtn = document.getElementById('structure-b-btn');
let structureSelected = null;

structureABtn?.addEventListener('click', () => {
    const icon = structureABtn.querySelector('svg');
    const text = structureABtn.lastChild;
    
    if (structureSelected === 'A') {
        structureABtn.className = 'w-full px-6 py-3 bg-blue-500 border-2 border-blue-500 rounded-lg text-white transition-all duration-200 font-medium';
        icon.className = 'w-8 h-8 mx-auto mb-2 text-white';
        text.textContent = 'Selected';
    } else {
        structureABtn.className = 'w-full px-6 py-3 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 font-medium';
        icon.className = 'w-8 h-8 mx-auto mb-2 text-gray-400';
        text.textContent = 'Select This';
    }
    structureSelected = 'A';
});

structureBBtn?.addEventListener('click', () => {
    const icon = structureBBtn.querySelector('svg');
    const text = structureBBtn.lastChild;
    
    if (structureSelected === 'B') {
        structureBBtn.className = 'w-full px-6 py-3 bg-blue-500 border-2 border-blue-500 rounded-lg text-white transition-all duration-200 font-medium';
        icon.className = 'w-8 h-8 mx-auto mb-2 text-white';
        text.textContent = 'Selected';
    } else {
        structureBBtn.className = 'w-full px-6 py-3 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 font-medium';
        icon.className = 'w-8 h-8 mx-auto mb-2 text-gray-400';
        text.textContent = 'Select This';
    }
    structureSelected = 'B';
});

// Interaction mode state
let currentMode = null; // 'pan', 'zoom', 'window', 'slice', or null

// Initialize Viewer
async function initializeViewer() {
    try {
        loadingTextLeft.textContent = 'Loading DICOM data...';
        loadingTextRight.textContent = 'Loading DICOM data...';
        
        const response = await fetch('{% url "dicom_handler:load_dicom_data" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                series_uid: '{{ series_uid }}',
                rt_structure_id: '{{ rt_structure_id }}',
            }),
        });

        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to load DICOM data');
        }

        viewerState.totalSlices = data.instance_count;
        viewerState.roiNames = data.roi_names || [];
        viewerState.roiColors = data.roi_colors || {};
        
        // Update UI
        totalSlicesSpan.textContent = viewerState.totalSlices;
        sliceSlider.max = viewerState.totalSlices - 1;
        sliceSlider.disabled = false;
        sliceInput.max = viewerState.totalSlices;
        sliceInput.disabled = false;
        goToSliceBtn.disabled = false;
        
        // Populate ROI list
        await populateROIList();
        
        // For now, skip pre-rendering for large series (>100 slices) due to timeout/memory issues
        // TODO: Implement batch rendering with progress updates
        if (viewerState.totalSlices <= 100) {
            loadingTextLeft.textContent = 'Pre-rendering all slices for instant navigation...';
            loadingTextRight.textContent = 'Pre-rendering all slices for instant navigation...';
            await preRenderAllSlices();
            
            // Display first slice from cache if available
            if (!displayCachedSlice(0)) {
                await loadSlice(0);
            }
        } else {
            // For large series, use on-demand loading with caching
            loadingTextLeft.textContent = '';
            loadingTextRight.textContent = '';
            await loadSlice(0);
        }
        
    } catch (error) {
        console.error('Error initializing viewer:', error);
        loadingTextLeft.textContent = 'Error: ' + error.message;
        loadingTextRight.textContent = 'Error: ' + error.message;
    }
}

// Pre-render all slices and cache them
async function preRenderAllSlices() {
    try {
        // Get selected ROIs (will be empty on initial load)
        const selectedROIs = [];
        const checkboxes = document.querySelectorAll('#roi-list input[type="checkbox"]:checked');
        if (checkboxes.length > 0) {
            checkboxes.forEach(cb => selectedROIs.push(cb.value));
        }
        
        const response = await fetch('{% url "dicom_handler:render_all_slices" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                window_center: viewerState.windowCenter,
                window_width: viewerState.windowWidth,
                selected_rois: selectedROIs,
            }),
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to render slices');
        }

        // Cache all rendered slices
        data.slices.forEach(slice => {
            sliceCache.set(slice.index, {
                image: slice.image,
                metadata: slice.metadata,
            });
        });
        
        loadingTextLeft.textContent = '';
        loadingTextRight.textContent = '';
        
    } catch (error) {
        loadingTextLeft.textContent = 'Warning: Pre-rendering failed, falling back to on-demand loading';
        loadingTextRight.textContent = 'Warning: Pre-rendering failed, falling back to on-demand loading';
        // Fall back to on-demand loading if pre-rendering fails
    }
}

// Display a cached slice (instant)
function displayCachedSlice(sliceIndex) {
    const cached = sliceCache.get(sliceIndex);
    if (cached) {
        // Display from cache (instant)
        dicomImageLeft.src = 'data:image/png;base64,' + cached.image;
        dicomImageRight.src = 'data:image/png;base64,' + cached.image;
        currentSliceSpan.textContent = sliceIndex + 1;
        sliceSlider.value = sliceIndex;
        sliceInput.value = sliceIndex + 1;
        
        viewerState.currentSlice = sliceIndex;
        return true;
    }
    return false;
}

// Fetch modification types from backend
let modificationTypes = [];

async function fetchModificationTypes() {
    try {
        const response = await fetch('{% url "dicom_handler:get_modification_types" %}', {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken,
            }
        });
        
        const data = await response.json();
        if (data.success) {
            modificationTypes = data.modification_types;
        }
    } catch (error) {
        console.error('Error fetching modification types:', error);
    }
}

// Populate ROI List
async function populateROIList() {
    if (viewerState.roiNames.length === 0) {
        roiList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No ROI structures found</p>';
        return;
    }
    
    // Fetch modification types if not already loaded
    if (modificationTypes.length === 0) {
        await fetchModificationTypes();
    }

    // Helper function to generate rainbow color for fallback
    function getRainbowColor(index, total) {
        const t = index / Math.max(total - 1, 1);
        let r, g, b;
        
        if (t < 0.25) {
            r = 0;
            g = 4 * t;
            b = 1;
        } else if (t < 0.5) {
            r = 0;
            g = 1;
            b = 1 - 4 * (t - 0.25);
        } else if (t < 0.75) {
            r = 4 * (t - 0.5);
            g = 1;
            b = 0;
        } else {
            r = 1;
            g = 1 - 4 * (t - 0.75);
            b = 0;
        }
        
        // Convert to RGB 0-255
        r = Math.round(r * 255);
        g = Math.round(g * 255);
        b = Math.round(b * 255);
        
        return `rgb(${r}, ${g}, ${b})`;
    }

    roiList.innerHTML = '';
    const totalROIs = viewerState.roiNames.length;
    
    viewerState.roiNames.forEach((roiName, index) => {
        const container = document.createElement('div');
        container.className = 'border border-gray-200 rounded-lg p-3 bg-gray-50';
        
        // Checkbox row
        const checkboxRow = document.createElement('div');
        checkboxRow.className = 'flex items-center mb-2';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `roi-${index}`;
        checkbox.value = roiName;
        checkbox.className = 'rounded border-gray-300 text-purple-600 focus:ring-purple-500 mr-2';
        
        // Get color from RT Structure or use rainbow fallback
        let color;
        if (viewerState.roiColors && viewerState.roiColors[roiName]) {
            const c = viewerState.roiColors[roiName];
            color = `rgb(${c.r}, ${c.g}, ${c.b})`;
        } else {
            color = getRainbowColor(index, totalROIs);
        }
        
        // Color indicator box
        const colorBox = document.createElement('div');
        colorBox.className = 'w-4 h-4 rounded mr-2 border border-gray-300';
        colorBox.style.backgroundColor = color;
        colorBox.title = `Color for ${roiName}`;
        
        const label = document.createElement('label');
        label.htmlFor = `roi-${index}`;
        label.textContent = roiName;
        label.className = 'text-sm font-medium text-gray-700 cursor-pointer flex-1';
        
        // Add toggle button for rating section
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'ml-auto text-gray-500 hover:text-purple-600 transition-colors';
        toggleBtn.innerHTML = `
            <svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        `;
        toggleBtn.title = 'Toggle rating form';
        
        checkboxRow.appendChild(checkbox);
        checkboxRow.appendChild(colorBox);
        checkboxRow.appendChild(label);
        checkboxRow.appendChild(toggleBtn);
        
        // Rating form section (initially hidden and disabled)
        const ratingSection = document.createElement('div');
        ratingSection.className = 'ml-6 space-y-2 hidden opacity-50';
        ratingSection.id = `rating-section-${roiName}`;
        
        // Toggle functionality
        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = ratingSection.classList.contains('hidden');
            ratingSection.classList.toggle('hidden');
            toggleBtn.querySelector('svg').style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        });
        
        // Modification dropdown
        const modLabel = document.createElement('label');
        modLabel.className = 'block text-xs text-gray-600 mb-1';
        modLabel.textContent = 'Contour Modification:';
        
        const modSelect = document.createElement('select');
        modSelect.id = `modification-${roiName}`;
        modSelect.className = 'w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-purple-500 focus:border-purple-500';
        modSelect.disabled = true; // Initially disabled
        modSelect.innerHTML = `
            <option value="NO_MODIFICATION" selected>No Modification</option>
            <option value="MINOR_MODIFICATION">Minor Modification</option>
            <option value="MAJOR_MODIFICATION">Major Modification</option>
            <option value="NOT_SEGMENTED">Not Segmented</option>
        `;
        
        ratingSection.appendChild(modLabel);
        ratingSection.appendChild(modSelect);
        
        // Modification type checkboxes
        if (modificationTypes.length > 0) {
            const typeLabel = document.createElement('label');
            typeLabel.className = 'block text-xs text-gray-600 mb-1 mt-2';
            typeLabel.textContent = 'Modification Type (if applicable):';
            ratingSection.appendChild(typeLabel);
            
            const typeContainer = document.createElement('div');
            typeContainer.className = 'space-y-1 max-h-32 overflow-y-auto border border-gray-200 rounded p-2';
            
            modificationTypes.forEach(modType => {
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'flex items-center';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `modtype-${roiName}-${modType.id}`;
                checkbox.value = modType.id;
                checkbox.className = 'rounded border-gray-300 text-purple-600 focus:ring-purple-500 mr-2';
                
                const label = document.createElement('label');
                label.htmlFor = `modtype-${roiName}-${modType.id}`;
                label.textContent = modType.name;
                label.className = 'text-xs text-gray-700 cursor-pointer';
                
                // Store selected types in state
                checkbox.addEventListener('change', (e) => {
                    const rating = initStructureRating(roiName);
                    if (!rating.modificationTypes) {
                        rating.modificationTypes = [];
                    }
                    
                    if (e.target.checked) {
                        if (!rating.modificationTypes.includes(modType.id)) {
                            rating.modificationTypes.push(modType.id);
                        }
                    } else {
                        rating.modificationTypes = rating.modificationTypes.filter(id => id !== modType.id);
                    }
                });
                
                checkboxWrapper.appendChild(checkbox);
                checkboxWrapper.appendChild(label);
                typeContainer.appendChild(checkboxWrapper);
            });
            
            ratingSection.appendChild(typeContainer);
        }
        // Comments textarea
        const commentsLabel = document.createElement('label');
        commentsLabel.className = 'block text-xs text-gray-600 mb-1 mt-2';
        commentsLabel.textContent = 'Comments:';
        
        const commentsTextarea = document.createElement('textarea');
        commentsTextarea.id = `comments-${roiName}`;
        commentsTextarea.className = 'w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-purple-500 focus:border-purple-500';
        commentsTextarea.rows = 2;
        commentsTextarea.placeholder = 'Add any comments about this structure...';
        commentsTextarea.disabled = true; // Initially disabled
        
        ratingSection.appendChild(commentsLabel);
        ratingSection.appendChild(commentsTextarea);
        
        // Store data in state when changed
        modSelect.addEventListener('change', (e) => {
            const rating = initStructureRating(roiName);
            rating.modification = e.target.value || null;
        });
        
        commentsTextarea.addEventListener('input', (e) => {
            const rating = initStructureRating(roiName);
            rating.comments = e.target.value.trim() || null;
        });
        
        container.appendChild(checkboxRow);
        container.appendChild(ratingSection);
        roiList.appendChild(container);
    });
}

// Load DICOM Slice
async function loadSlice(sliceIndex) {
    if (viewerState.isLoading) return;
    
    // Try to display from cache first (instant)
    if (displayCachedSlice(sliceIndex)) {
        dicomImageLeft.style.display = 'block';
        dicomImageRight.style.display = 'block';
        updateSliderBackground();
        return;
    }
    
    // If not cached, load from server (fallback)
    viewerState.isLoading = true;
    loadingOverlayLeft.style.display = 'flex';
    loadingOverlayRight.style.display = 'flex';
    
    try {
        // Get selected ROIs
        const selectedROIs = Array.from(document.querySelectorAll('#roi-list input[type="checkbox"]:checked'))
            .map(cb => cb.value);
        
        const response = await fetch('{% url "dicom_handler:get_dicom_slice" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                slice_index: sliceIndex,
                window_center: viewerState.windowCenter,
                window_width: viewerState.windowWidth,
                selected_rois: selectedROIs,
            }),
        });

        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to load slice');
        }

        // Cache this slice for future instant access
        sliceCache.set(sliceIndex, {
            image: data.image,
            metadata: data.metadata,
        });

        // Update image
        dicomImageLeft.src = 'data:image/png;base64,' + data.image;
        dicomImageLeft.style.display = 'block';
        dicomImageRight.src = 'data:image/png;base64,' + data.image;
        dicomImageRight.style.display = 'block';
        
        // Update slice info
        viewerState.currentSlice = sliceIndex;
        currentSliceSpan.textContent = sliceIndex + 1;
        
        // Update slider position (only if not currently being dragged)
        if (!isSliderDragging) {
            sliceSlider.value = sliceIndex;
            updateSliderBackground();
        }
        
        // Update input field
        sliceInput.value = sliceIndex + 1;
        
        // Show warning for failed ROIs
        if (data.failed_rois && data.failed_rois.length > 0) {
            updateFailedROIsIndicator(data.failed_rois);
        }
        
        loadingOverlayLeft.style.display = 'none';
        loadingOverlayRight.style.display = 'none';
        
    } catch (error) {
        console.error('Error loading slice:', error);
        loadingTextLeft.textContent = 'Error: ' + error.message;
        loadingTextRight.textContent = 'Error: ' + error.message;
    } finally {
        viewerState.isLoading = false;
    }
}

// Update slider background fill
function updateSliderBackground() {
    const value = sliceSlider.value;
    const max = sliceSlider.max;
    const percentage = max > 0 ? (value / max) * 100 : 0;
    sliceSlider.style.backgroundSize = `${percentage}% 8px`;
}

// Update failed ROIs indicator
function updateFailedROIsIndicator(failedRois) {
    failedRois.forEach(roiName => {
        // Find the checkbox for this ROI
        const checkboxes = document.querySelectorAll('#roi-list input[type="checkbox"]');
        checkboxes.forEach(cb => {
            if (cb.value === roiName) {
                const parentDiv = cb.closest('.roi-checkbox');
                if (parentDiv && !parentDiv.querySelector('.failed-indicator')) {
                    // Add warning indicator
                    const warning = document.createElement('span');
                    warning.className = 'failed-indicator ml-2 text-red-600 text-xs';
                    warning.innerHTML = '⚠️';
                    warning.title = `Cannot display: Invalid contour data`;
                    parentDiv.appendChild(warning);
                    
                    // Also add a red border
                    parentDiv.style.borderColor = '#dc2626';
                    parentDiv.style.backgroundColor = '#fef2f2';
                }
            }
        });
    });
}

// Event Listeners
let isSliderDragging = false;
sliceSlider.addEventListener('input', (e) => {
    updateSliderBackground();
    if (!isSliderDragging) {
        isSliderDragging = true;
        loadSlice(parseInt(e.target.value)).finally(() => {
            isSliderDragging = false;
        });
    }
});

// Slice input field - Go button
goToSliceBtn.addEventListener('click', () => {
    const sliceNumber = parseInt(sliceInput.value);
    if (sliceNumber >= 1 && sliceNumber <= viewerState.totalSlices) {
        loadSlice(sliceNumber - 1); // Convert to 0-indexed
    } else {
        alert(`Please enter a slice number between 1 and ${viewerState.totalSlices}`);
    }
});

// Slice input field - Enter key
sliceInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        goToSliceBtn.click();
    }
});

// Slice input field - validate on input
sliceInput.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    if (value < 1) {
        e.target.value = 1;
    } else if (value > viewerState.totalSlices) {
        e.target.value = viewerState.totalSlices;
    }
});

// Mouse wheel scrolling - only when hovering over the image
let isMouseOverImage = false;

dicomImageLeft.addEventListener('mouseenter', () => {
    isMouseOverImage = true;
});

dicomImageRight.addEventListener('mouseenter', () => {
    isMouseOverImage = true;
});

dicomImageLeft.addEventListener('mouseleave', () => {
    isMouseOverImage = false;
});

dicomImageRight.addEventListener('mouseleave', () => {
    isMouseOverImage = false;
});

// Add wheel event listeners to both viewer containers
document.getElementById('viewer-container-left').addEventListener('wheel', (e) => {
    // Only prevent default and scroll slices if mouse is over the image
    if (isMouseOverImage) {
        e.preventDefault();
        e.stopPropagation();
        
        // Scroll up = increase slice number (move up through body)
        if (e.deltaY < 0 && viewerState.currentSlice < viewerState.totalSlices - 1) {
            loadSlice(viewerState.currentSlice + 1);
        }
        // Scroll down = decrease slice number (move down through body)
        else if (e.deltaY > 0 && viewerState.currentSlice > 0) {
            loadSlice(viewerState.currentSlice - 1);
        }
    }
}, { passive: false });

document.getElementById('viewer-container-right').addEventListener('wheel', (e) => {
    // Only prevent default and scroll slices if mouse is over the image
    if (isMouseOverImage) {
        e.preventDefault();
        e.stopPropagation();
        
        // Scroll up = increase slice number (move up through body)
        if (e.deltaY < 0 && viewerState.currentSlice < viewerState.totalSlices - 1) {
            loadSlice(viewerState.currentSlice + 1);
        }
        // Scroll down = decrease slice number (move down through body)
        else if (e.deltaY > 0 && viewerState.currentSlice > 0) {
            loadSlice(viewerState.currentSlice - 1);
        }
    }
}, { passive: false });

// Window/Level controls
let windowLevelTimeout = null;

windowCenterInput.addEventListener('input', (e) => {
    viewerState.windowCenter = parseInt(e.target.value);
    wcValueSpan.textContent = viewerState.windowCenter;
    
    // Debounce the reload for smooth slider interaction
    clearTimeout(windowLevelTimeout);
    windowLevelTimeout = setTimeout(() => {
        sliceCache.clear();
        loadSlice(viewerState.currentSlice);
    }, 100);
});

windowWidthInput.addEventListener('input', (e) => {
    viewerState.windowWidth = parseInt(e.target.value);
    wwValueSpan.textContent = viewerState.windowWidth;
    
    // Debounce the reload for smooth slider interaction
    clearTimeout(windowLevelTimeout);
    windowLevelTimeout = setTimeout(() => {
        sliceCache.clear();
        loadSlice(viewerState.currentSlice);
    }, 100);
});

// Preset buttons
document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const wc = parseInt(btn.dataset.wc);
        const ww = parseInt(btn.dataset.ww);
        
        viewerState.windowCenter = wc;
        viewerState.windowWidth = ww;
        
        windowCenterInput.value = wc;
        windowWidthInput.value = ww;
        wcValueSpan.textContent = wc;
        wwValueSpan.textContent = ww;
        
        // Clear cache and reload with new window/level
        sliceCache.clear();
        loadSlice(viewerState.currentSlice);
    });
});

// ROI selection
selectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('#roi-list input[type="checkbox"][id^="roi-"]').forEach(cb => {
        cb.checked = true;
    });
});

deselectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('#roi-list input[type="checkbox"][id^="roi-"]').forEach(cb => {
        cb.checked = false;
    });
});

applyOverlayBtn.addEventListener('click', () => {
    // Clear cache to force re-render with new ROI selections
    sliceCache.clear();
    
    loadSlice(viewerState.currentSlice);
    
    // Show overall rating section at the top
    const overallRatingSection = document.getElementById('overall-rating-section');
    if (overallRatingSection) {
        overallRatingSection.style.display = 'block';
    }
    
    // Enable/disable rating forms based on which structures are checked
    document.querySelectorAll('#roi-list input[type="checkbox"][id^="roi-"]').forEach(checkbox => {
        const roiName = checkbox.value;
        const ratingSection = document.getElementById(`rating-section-${roiName}`);
        
        if (ratingSection) {
            const isChecked = checkbox.checked;
            
            // Enable/disable all form elements in the rating section
            const formElements = ratingSection.querySelectorAll('select, textarea, input');
            formElements.forEach(element => {
                element.disabled = !isChecked;
            });
            
            // Add/remove visual indication
            if (isChecked) {
                ratingSection.classList.remove('opacity-50');
            } else {
                ratingSection.classList.add('opacity-50');
            }
        }
    });
});

// Mode switching
function setMode(mode) {
    currentMode = mode;
    
    // Hide all control panels
    document.getElementById('zoom-controls-panel').classList.add('hidden');
    document.getElementById('window-controls-panel').classList.add('hidden');
    document.getElementById('slice-controls-panel').classList.add('hidden');
    
    // Update button styles
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('bg-purple-600', 'text-white');
        btn.classList.add('bg-white', 'text-gray-700');
    });
    
    if (mode === 'pan') {
        modePanBtn.classList.remove('bg-white', 'text-gray-700');
        modePanBtn.classList.add('bg-purple-600', 'text-white');
        currentModeText.textContent = 'Mode: Pan (Click & Drag)';
        dicomImageLeft.style.cursor = 'grab';
        dicomImageRight.style.cursor = 'grab';
    } else if (mode === 'zoom') {
        modeZoomBtn.classList.remove('bg-white', 'text-gray-700');
        modeZoomBtn.classList.add('bg-purple-600', 'text-white');
        currentModeText.textContent = 'Mode: Zoom';
        dicomImageLeft.style.cursor = 'zoom-in';
        dicomImageRight.style.cursor = 'zoom-in';
        document.getElementById('zoom-controls-panel').classList.remove('hidden');
    } else if (mode === 'window') {
        modeWindowBtn.classList.remove('bg-white', 'text-gray-700');
        modeWindowBtn.classList.add('bg-purple-600', 'text-white');
        currentModeText.textContent = 'Mode: Window/Level';
        dicomImageLeft.style.cursor = 'crosshair';
        dicomImageRight.style.cursor = 'crosshair';
        document.getElementById('window-controls-panel').classList.remove('hidden');
    } else if (mode === 'slice') {
        modeSliceBtn.classList.remove('bg-white', 'text-gray-700');
        modeSliceBtn.classList.add('bg-purple-600', 'text-white');
        currentModeText.textContent = 'Mode: Slice Navigation';
        dicomImageLeft.style.cursor = 'ns-resize';
        dicomImageRight.style.cursor = 'ns-resize';
        document.getElementById('slice-controls-panel').classList.remove('hidden');
    } else {
        currentModeText.textContent = 'Mode: None';
        dicomImageLeft.style.cursor = 'default';
        dicomImageRight.style.cursor = 'default';
    }
}

// Mode button handlers
modePanBtn.addEventListener('click', () => setMode('pan'));
modeZoomBtn.addEventListener('click', () => setMode('zoom'));
modeWindowBtn.addEventListener('click', () => setMode('window'));
modeSliceBtn.addEventListener('click', () => setMode('slice'));

// Interaction state
let interactionState = {
    isActive: false,
    startX: 0,
    startY: 0,
    translateX: 0,
    translateY: 0,
    startZoom: 100,
    startWindowCenter: 40,
    startWindowWidth: 400,
    startSlice: 0
};

function applyZoom(zoomLevel) {
    const scale = zoomLevel / 100;
    dicomImageLeft.style.transform = `translate(${interactionState.translateX}px, ${interactionState.translateY}px) scale(${scale})`;
    dicomImageRight.style.transform = `translate(${interactionState.translateX}px, ${interactionState.translateY}px) scale(${scale})`;
    dicomImageLeft.style.transformOrigin = 'center center';
    dicomImageRight.style.transformOrigin = 'center center';
    zoomValueSpan.textContent = `${zoomLevel}%`;
    zoomSlider.value = zoomLevel;
}

zoomSlider.addEventListener('input', (e) => {
    const zoomLevel = parseInt(e.target.value);
    applyZoom(zoomLevel);
});

zoomInBtn.addEventListener('click', () => {
    const currentZoom = parseInt(zoomSlider.value);
    const newZoom = Math.min(400, currentZoom + 25);
    applyZoom(newZoom);
});

zoomOutBtn.addEventListener('click', () => {
    const currentZoom = parseInt(zoomSlider.value);
    const newZoom = Math.max(50, currentZoom - 25);
    applyZoom(newZoom);
});

zoomResetBtn.addEventListener('click', () => {
    interactionState.translateX = 0;
    interactionState.translateY = 0;
    applyZoom(100);
});

// Mouse interaction handlers
dicomImageLeft.addEventListener('mousedown', (e) => {
    if (!currentMode) return;
    
    interactionState.isActive = true;
    interactionState.startX = e.clientX;
    interactionState.startY = e.clientY;
    
    if (currentMode === 'pan') {
        interactionState.startX = e.clientX - interactionState.translateX;
        interactionState.startY = e.clientY - interactionState.translateY;
        dicomImageLeft.style.cursor = 'grabbing';
        dicomImageRight.style.cursor = 'grabbing';
    } else if (currentMode === 'zoom') {
        interactionState.startZoom = parseInt(zoomSlider.value);
    } else if (currentMode === 'window') {
        interactionState.startWindowCenter = parseInt(windowCenterInput.value);
        interactionState.startWindowWidth = parseInt(windowWidthInput.value);
    } else if (currentMode === 'slice') {
        interactionState.startSlice = viewerState.currentSlice;
    }
    
    e.preventDefault();
});

dicomImageRight.addEventListener('mousedown', (e) => {
    if (!currentMode) return;
    
    interactionState.isActive = true;
    interactionState.startX = e.clientX;
    interactionState.startY = e.clientY;
    
    if (currentMode === 'pan') {
        interactionState.startX = e.clientX - interactionState.translateX;
        interactionState.startY = e.clientY - interactionState.translateY;
        dicomImageLeft.style.cursor = 'grabbing';
        dicomImageRight.style.cursor = 'grabbing';
    } else if (currentMode === 'zoom') {
        interactionState.startZoom = parseInt(zoomSlider.value);
    } else if (currentMode === 'window') {
        interactionState.startWindowCenter = parseInt(windowCenterInput.value);
        interactionState.startWindowWidth = parseInt(windowWidthInput.value);
    } else if (currentMode === 'slice') {
        interactionState.startSlice = viewerState.currentSlice;
    }
    
    e.preventDefault();
});

document.addEventListener('mousemove', (e) => {
    if (!interactionState.isActive || !currentMode) return;
    
    if (currentMode === 'pan') {
        interactionState.translateX = e.clientX - interactionState.startX;
        interactionState.translateY = e.clientY - interactionState.startY;
        const currentZoom = parseInt(zoomSlider.value);
        const scale = currentZoom / 100;
        dicomImageLeft.style.transform = `translate(${interactionState.translateX}px, ${interactionState.translateY}px) scale(${scale})`;
        dicomImageRight.style.transform = `translate(${interactionState.translateX}px, ${interactionState.translateY}px) scale(${scale})`;
    } else if (currentMode === 'zoom') {
        const deltaY = interactionState.startY - e.clientY;
        const zoomChange = Math.floor(deltaY / 2);
        const newZoom = Math.max(50, Math.min(400, interactionState.startZoom + zoomChange));
        applyZoom(newZoom);
    } else if (currentMode === 'window') {
        const deltaX = e.clientX - interactionState.startX;
        const deltaY = interactionState.startY - e.clientY;
        
        const newCenter = interactionState.startWindowCenter + deltaX;
        const newWidth = Math.max(1, interactionState.startWindowWidth + deltaY * 2);
        
        windowCenterInput.value = newCenter;
        windowWidthInput.value = newWidth;
        wcValueSpan.textContent = newCenter;
        wwValueSpan.textContent = newWidth;
        
        viewerState.windowCenter = newCenter;
        viewerState.windowWidth = newWidth;
        
        // Clear cache and reload current slice with new window/level
        sliceCache.clear();
        loadSlice(viewerState.currentSlice);
    } else if (currentMode === 'slice') {
        const deltaY = interactionState.startY - e.clientY;
        const sliceChange = Math.floor(deltaY / 10);
        const newSlice = Math.max(0, Math.min(viewerState.totalSlices - 1, interactionState.startSlice + sliceChange));
        
        if (newSlice !== viewerState.currentSlice) {
            loadSlice(newSlice);
        }
    }
});

document.addEventListener('mouseup', () => {
    if (interactionState.isActive) {
        interactionState.isActive = false;
        
        if (currentMode === 'pan') {
            dicomImageLeft.style.cursor = 'grab';
            dicomImageRight.style.cursor = 'grab';
        }
    }
});

// Rating System
const ratingState = {
    overallRating: 5,
    modificationTime: null,
    assessorName: null,
    dateReviewed: null,
    structureRatings: {}
};

// Helper function to initialize structure rating
function initStructureRating(roiName) {
    if (!ratingState.structureRatings) {
        ratingState.structureRatings = {};
    }
    if (!ratingState.structureRatings[roiName]) {
        ratingState.structureRatings[roiName] = {};
    }
    return ratingState.structureRatings[roiName];
}

// Modification time input handler
document.getElementById('modification-time')?.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    ratingState.modificationTime = value > 0 ? value : null;
});

// Assessor name input handler
document.getElementById('assessor-name')?.addEventListener('input', (e) => {
    ratingState.assessorName = e.target.value.trim() || null;
});

// Date reviewed input handler
document.getElementById('date-reviewed')?.addEventListener('input', (e) => {
    ratingState.dateReviewed = e.target.value || null;
});

// Cleanup on page unload
window.addEventListener('beforeunload', async () => {
    await fetch('{% url "dicom_handler:cleanup_temp_files" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        },
    });
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    // Only handle arrow keys if not typing in an input
    if (e.target.tagName === 'INPUT' && e.target.type !== 'range') return;
    
    if (e.key === 'ArrowUp' || e.key === 'ArrowRight') {
        e.preventDefault();
        if (viewerState.currentSlice < viewerState.totalSlices - 1) {
            loadSlice(viewerState.currentSlice + 1);
        }
    } else if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') {
        e.preventDefault();
        if (viewerState.currentSlice > 0) {
            loadSlice(viewerState.currentSlice - 1);
        }
    }
});

// Initialize viewer on page load
document.addEventListener('DOMContentLoaded', () => {
    initializeViewer();
});
</script>
{% endblock %}